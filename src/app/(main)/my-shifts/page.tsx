import { UserShiftTable } from "@/app/(main)/my-shifts/_components";
import { FULL_MONTHS, NUM_MONTHS } from "@/app/constants";
import { NotiMessage } from "@/components/noti-message";
import { CurrentBadge, Typography } from "@/components/shared";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { getUserShiftsInDateRange } from "@/data-access/employee";
import { getCurrentSession } from "@/lib/auth/session";
import { formatMoney } from "@/lib/utils";
import { getTodayStartOfDay } from "@/utils/datetime";
import {
  getDayRangeByMonthAndYear,
  getPeriodsByMonthAndYear,
  populateMonthSelectData,
} from "@/utils/hours-tips";
import { authenticatedRateLimit } from "@/utils/rate-limiter";
import {
  ArrowRight01Icon,
  Calendar03Icon,
  Clock01Icon,
  CoinsDollarIcon,
} from "@hugeicons/core-free-icons";
import { HugeiconsIcon } from "@hugeicons/react";
import { format } from "date-fns";
import { notFound, redirect } from "next/navigation";

type SearchParams = Promise<{
  year?: string;
  month?: string;
}>;

export default async function Page(props: { searchParams: SearchParams }) {
  const { session, user } = await getCurrentSession();
  if (!session) redirect("/login");
  if (user.accountStatus !== "active") return notFound();

  if (!(await authenticatedRateLimit(user.id))) {
    return <NotiMessage variant="error" message="Too many requests. Please try again later." />;
  }

  const searchParams = await props.searchParams;
  const { years } = await populateMonthSelectData();

  const today = getTodayStartOfDay();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();

  if (!searchParams.year || !searchParams.month) {
    redirect(`/my-shifts?year=${currentYear}&month=${currentMonth + 1}`);
  }

  const selectedYear = parseInt(searchParams.year);
  const selectedMonth = parseInt(searchParams.month);

  if (
    isNaN(selectedYear) ||
    isNaN(selectedMonth) ||
    !years.includes(selectedYear) ||
    !NUM_MONTHS.includes(selectedMonth)
  ) {
    return (
      <NotiMessage
        variant="error"
        message="Invalid year or month. Please check the URL and try again."
      />
    );
  }

  const monthIndex = selectedMonth - 1;
  const dateRange = getDayRangeByMonthAndYear(selectedYear, monthIndex);
  const periods = getPeriodsByMonthAndYear(selectedYear, monthIndex);
  const userShifts = await getUserShiftsInDateRange(user.id, dateRange);

  const firstPeriodShifts = userShifts.filter((shift) => shift.date.getDate() <= 15);
  const secondPeriodShifts = userShifts.filter((shift) => shift.date.getDate() > 15);

  const isCurrentPeriod = selectedYear === currentYear && monthIndex === currentMonth;

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            {FULL_MONTHS[monthIndex]} {selectedYear}
            {isCurrentPeriod && <CurrentBadge />}
          </CardTitle>
        </CardHeader>

        <CardContent className="grid gap-3 sm:grid-cols-2">
          <div className="flex items-center gap-3">
            <div className="bg-accent flex size-10 items-center justify-center rounded-full">
              <HugeiconsIcon icon={Clock01Icon} className="text-accent-foreground size-5" />
            </div>
            <div>
              <Typography className="text-xs">Total Hours</Typography>
              <Typography variant="caption">
                {userShifts.reduce((acc, shift) => acc + shift.hours, 0)}
              </Typography>
            </div>
          </div>

          <div className="flex items-center gap-3">
            <div className="bg-accent flex size-10 items-center justify-center rounded-full">
              <HugeiconsIcon icon={CoinsDollarIcon} className="text-accent-foreground size-5" />
            </div>
            <div>
              <Typography className="text-xs">Total Tips</Typography>
              <Typography variant="caption">
                {formatMoney(userShifts.reduce((acc, shift) => acc + shift.tips, 0) / 100)}
              </Typography>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Daily Breakdown</CardTitle>
        </CardHeader>

        <CardContent className="space-y-10">
          {periods.map((period, index) => (
            <div key={index} className="space-y-6">
              <Typography variant="h3" className="flex items-center gap-2">
                <HugeiconsIcon icon={Calendar03Icon} className="size-5" />
                <span>{format(period.start, "MMM d")}</span>
                <HugeiconsIcon icon={ArrowRight01Icon} className="size-4" />
                <span>{format(period.end, "MMM d")}</span>
              </Typography>

              <UserShiftTable
                dateRange={period}
                userShifts={index === 0 ? firstPeriodShifts : secondPeriodShifts}
              />
            </div>
          ))}
        </CardContent>
      </Card>
    </div>
  );
}
